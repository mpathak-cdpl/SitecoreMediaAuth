<?xml version="1.0" encoding="utf-8" ?>
<!--
  Purpose: Configuration for Media Security module with claims-based authorization
  
  This configuration:
  1. Registers the SecureMediaRequestProcessor in the httpRequestBegin pipeline
  2. Configures dependency injection for authorization services
  3. Defines settings for claim validation and feature toggles
  
  IMPORTANT: This processor runs BEFORE ItemResolver to intercept media requests
  early in the pipeline, before media caching occurs.
-->
<configuration xmlns:patch="http://www.sitecore.net/xmlconfig/" xmlns:role="http://www.sitecore.net/xmlconfig/role/">
  <sitecore>
    
    <!-- Settings -->
    <settings>
      
      <!-- 
        MediaSecurity.Enabled
        Master toggle for the media security feature.
        Set to false to disable all authorization checks (useful for troubleshooting).
        Default: true
      -->
      <setting name="MediaSecurity.Enabled" value="true" />
      
      <!-- 
        MediaSecurity.ClaimUrlBase
        Base URL for full-form claims (e.g., https://ipcoop.com/claims/).
        The system will check for both full URL claims (base + claim name) and short-form claims.
        Example: With base "https://ipcoop.com/claims/" and claim "hasHawaiiState",
                 the system checks for both "https://ipcoop.com/claims/hasHawaiiState" and "hasHawaiiState"
        Default: https://ipcoop.com/claims/
      -->
      <setting name="MediaSecurity.ClaimUrlBase" value="https://ipcoop.com/claims/" />
      
    </settings>

    <!-- Pipeline Configuration -->
    <pipelines>
      <!-- Media Stream Pipeline - This is where media requests are actually processed -->
      <getMediaStream>
        
        <!-- 
          SecureMediaRequestProcessor
          Intercepts media stream requests to enforce authorization BEFORE media is served.
          
          Key behaviors:
          - Runs in getMediaStream pipeline (the correct pipeline for media authorization)
          - Checks for Secure Media Folder template in item ancestry
          - Validates RuleName field and user claims (3 methods: full URL, short name, user profile)
          - Returns 401 for unauthenticated users (prompts login)
          - Returns 403 for authenticated users without required claims
          - Bypasses cache for all secured media items
          - Comprehensive logging for troubleshooting
          
          Position: Early in getMediaStream pipeline before media is retrieved
        -->
        <processor 
          type="IPCoop.Foundation.MediaSecurity.Pipelines.GetMediaStream.SecureMediaStreamProcessor, IPCoop.Foundation.MediaSecurity"
          resolve="true"
          patch:before="*[1]">
          <param desc="authorizationService" ref="mediaSecurity/authorizationService" />
        </processor>
        
      </getMediaStream>
    </pipelines>

    <!-- Dependency Injection Configuration -->
    <services>
      
      <!-- 
        Register the MediaSecurityServicesConfigurator
        This configurator registers all services required by the Media Security module
      -->
      <configurator type="IPCoop.Foundation.MediaSecurity.Configuration.MediaSecurityServicesConfigurator, IPCoop.Foundation.MediaSecurity" />
      
    </services>

    <!-- Service References for Dependency Injection -->
    <mediaSecurity>
      
      <!-- 
        Authorization Service
        Provides media access authorization based on user claims and folder rules
      -->
      <authorizationService type="IPCoop.Foundation.MediaSecurity.Security.Interfaces.IMediaAuthorizationService, IPCoop.Foundation.MediaSecurity" />
      
    </mediaSecurity>

  </sitecore>
</configuration>
